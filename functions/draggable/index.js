/*
é—®é¢˜ï¼š
æµè§ˆå™¨åœ¨ dragstart äº‹ä»¶æœŸé—´ä¼šåˆ›å»ºä¸€ä¸ªâ€œæ‹–æ‹½å½±å­å…ƒç´ â€ï¼ˆDrag Imageï¼‰ï¼Œè€Œè¿™ä¸ªå½±å­å…ƒç´ å°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„æ­£åœ¨æ‹–åŠ¨çš„é‚£ä¸ªå¯è§†åŒ–å…ƒç´ ã€‚
å¦‚æœç«‹åˆ»ç»™å…ƒç´ æ·»åŠ ç±»åï¼ˆæ¯”å¦‚ .movingï¼‰ï¼Œè¿™ä¸ªç±»åä¼šåŒæ—¶å‡ºç°åœ¨çœŸå®çš„ DOM å…ƒç´ ä¸Šå’Œæ‹–æ‹½å½±å­å…ƒç´ ä¸Šï¼Œè¿™å°±å¯¼è‡´æ‹–æ‹½çš„å…ƒç´ å’Œå®ƒçš„åŸå§‹ä½ç½®éƒ½å˜äº†æ ·å¼ã€‚
*/

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜
const list = document.querySelector('.list')
let draggingElement

// ç»™ list ç»‘å®šæ‹–æ‹½å¼€å§‹äº‹ä»¶ï¼Œä¿®æ”¹å…ƒç´ å ä½ç©ºé—´çš„æ ·å¼
list.addEventListener('dragstart', (e) => {
  e.dataTransfer.effectAllowed = 'move' // ä¿®æ”¹æ‹–æ‹½æ—¶çš„é¼ æ ‡æ ·å¼
  draggingElement = e.target // è·å–æ­£åœ¨æ‹–æ‹½çš„å…ƒç´ 
  // éœ€æ±‚ï¼šè¢«æ‹–æ‹½çš„å…ƒç´ æ ·å¼ä¸å˜ï¼›åªæ”¹å˜å…ƒç´ å ä½ç©ºé—´çš„æ ·å¼ã€‚å¯ä»¥ä½¿ç”¨å¼‚æ­¥çš„æ–¹æ³•è§£å†³ä¸Šè¿°é—®é¢˜
  // å»¶è¿Ÿæ·»åŠ ç±»åï¼Œè®©ç±»ååªä½œç”¨äºåŸå§‹ DOM å…ƒç´ ï¼Œä¸å½±å“æµè§ˆå™¨ç”Ÿæˆçš„æ‹–æ‹½å½±å­å…ƒç´ ï¼Œä»è€Œå®ç°â€œåªæ”¹å˜åŸä½ç½®æ ·å¼ã€ä¸æ”¹å˜æ‹–æ‹½å…ƒç´ å¤–è§‚â€çš„æ•ˆæœã€‚
  setTimeout(() => {
    // ç»™çœŸæ­£è§¦å‘äº‹ä»¶çš„å…ƒç´ æ·»åŠ  moving ç±»åï¼Œå³å…ƒç´ è¢«æ‹–æ‹½æ—¶çš„æ ·å¼
    e.target.classList.add('moving')
  }, 0)
})

// å®ç°æ‹–æ‹½æ’åºã€‚å½“é¼ æ ‡æ‹–æ‹½ç€å…ƒç´ ï¼Œå¹¶ä¸”è¿›å…¥å…¶ä»–å…ƒç´ æ—¶ï¼Œè§¦å‘ dragenter äº‹ä»¶ã€‚e.target æ˜¯è¿›å…¥å…ƒç´ çš„å€¼ã€‚
list.addEventListener('dragenter', (e) => {
  e.preventDefault() // æµè§ˆå™¨é»˜è®¤å¯¹å“ªäº›å…ƒç´ å¯ä»¥æ¥å—â€œæ‹–æ”¾â€æ˜¯æœ‰ä¿æŠ¤æœºåˆ¶çš„ï¼Œå¯¼è‡´æ‹–æ‹½çš„å…ƒç´ æ— æ³•çœŸæ­£"æ”¾ä¸‹æ¥"ã€‚
  // console.log('e.target: ', e.target) // e.target åŒ…æ‹¬å…ƒç´ è‡ªèº«å’Œçˆ¶å…ƒç´ 
  if (!draggingElement) return

  const target = e.target

  // å½“é¼ æ ‡è¿›å…¥çš„å…ƒç´ æ˜¯çˆ¶å…ƒç´ æˆ–å…ƒç´ è‡ªèº«æ—¶ï¼Œä¸è¿›è¡Œå¤„ç†
  if (target === list || target === draggingElement) return

  // å°†æ‰€æœ‰æ‹–æ‹½å…ƒç´ åˆ›å»ºæˆä¸€ä¸ªæ•°ç»„ï¼Œå¹¶è·å–å½“å‰è¢«æ‹–æ‹½å…ƒç´ å’Œå½“å‰è¿›å…¥çš„å…ƒç´ ï¼ˆç›®æ ‡å…ƒç´ ï¼‰çš„ä¸‹æ ‡
  const dragIndex = [...list.children].indexOf(draggingElement)
  const targetIndex = [...list.children].indexOf(target)

  // å®ç°æ’åº
  if (dragIndex < targetIndex) {
    list.insertBefore(draggingElement, target.nextElementSibling)
  } else {
    list.insertBefore(draggingElement, target)
  }
})

list.addEventListener('dragover', (e) => {
  // æ²¡æœ‰å®ƒï¼šä½ åœ¨æ‹–åŠ¨æ—¶ï¼Œé¼ æ ‡é€šå¸¸ä¼šæ˜¾ç¤ºä¸€ä¸ªâ€œç¦æ­¢ç¬¦å·â€ï¼ˆåœ†åœˆå¸¦æ–œæ ğŸš«ï¼‰ï¼Œç»™ç”¨æˆ·çš„æ„Ÿè§‰æ˜¯â€œè¿™é‡Œä¸èƒ½æ”¾â€ã€‚è™½ç„¶ä½ ä¸€æ¾æ‰‹å‘ç°ä½ç½®æ¢äº†ï¼Œä½†æ“ä½œè¿‡ç¨‹ä¸­çš„åé¦ˆæ˜¯é”™è¯¯çš„ã€‚
  // æœ‰å®ƒï¼šå‘Šè¯‰æµè§ˆå™¨â€œè¿™é‡Œæ˜¯åˆæ³•çš„â€ï¼Œé¼ æ ‡ä¼šå˜æˆâ€œç§»åŠ¨â€æˆ–â€œç®­å¤´â€å›¾æ ‡ï¼Œäº¤äº’æ›´è‡ªç„¶ã€‚
  // é˜²æ­¢å›å¼¹ï¼šåœ¨æŸäº›ä¸¥æ ¼çš„æµè§ˆå™¨æˆ–æ“ä½œç³»ç»Ÿä¸­ï¼Œå¦‚æœåˆ¤å®š Drop æ— æ•ˆï¼Œå®ƒå¯èƒ½ä¼šå±•ç¤ºä¸€ä¸ªâ€œå…ƒç´ é£å›åŸå¤„â€çš„åŠ¨ç”»æ•ˆæœï¼ˆè™½ç„¶ DOM å®é™…ä¸Šå·²ç»å˜äº†ï¼Œè¿™ä¼šé€ æˆè§†è§‰ä¸Šçš„é—ªçƒæˆ–æ€ªå¼‚ï¼‰ã€‚
  e.preventDefault()
})

// æ‹–æ‹½å®Œæˆåéœ€è¦ç§»é™¤ moving ç±»åï¼Œå¹¶æ¢å¤å…ƒç´ æ ·å¼
list.addEventListener('dragend', (e) => {
  // ç§»é™¤ moving ç±»åï¼Œæ¢å¤å…ƒç´ æ ·å¼
  draggingElement.classList.remove('moving')

  // æ¸…ç©ºæ­£åœ¨æ‹–æ‹½çš„å…ƒç´ 
  draggingElement = null
})
